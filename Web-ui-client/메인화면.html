<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>FastAPI ê²€ìƒ‰ í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script>
        Kakao.init('00a14c8dd77d4e2846f5e49ed7113fc7');
        function shareToKakao() {
            Kakao.Link.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”',
                    description: '',
                    imageUrl: 'http://127.0.0.1:5500/images/share-image.png',  
                    link: {
                        mobileWebUrl: 'http://127.0.0.1:5500/product-page.html',  
                        webUrl: 'http://127.0.0.1:5500/product-page.html' 
                    }
                },
                buttons: [
                    {
                        title: 'ì›¹ì‚¬ì´íŠ¸ ê°€ê¸°',
                        link: {
                            mobileWebUrl: 'http://127.0.0.1:5500/product-page.html',
                            webUrl: 'http://127.0.0.1:5500/product-page.html'
                    }
                }
            ]
            });
        }    

        function shareToInstagram() {
            var url = 'https://www.instagram.com/';
            window.open(url, '_blank');  
        }
    </script>
    <style>
        body {
            background-color: #1D2475;
            color: white;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            position: fixed;
            left: -270px;
            top: 0;
            height: 100%;
            background-color: lightgray;
            transition: left 0.4s ease-in-out;
            padding-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-left: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-content {
            margin-top: 30px;
            width: 100%;
        }
        .sidebar a {
            display: block;
            padding: 15px;
            font-size: 18px;
            text-decoration: none;
            color: black;
            text-align: left;
        }
        .sidebar a:hover {
            background-color: #ddd;
        }
        .setting-icon {
            display: none; 
            position: absolute;
            bottom: 60px;  
            right: 20px;   
            width: 40px;   
            height: auto;
            cursor: pointer;
            z-index: 100;            
        }

        .sidebar.open .setting-icon {
            display: block;
        }

        .sidebar.open .open-btn {
            filter: none;
        }
        
        .open-btn {
            position: absolute;
            top: 15px;
            width: 40px;
            cursor: pointer;
            z-index: 10;

        }
        .open-btn {
            position: absolute;
            top: 15px;
            width: 40px;
            cursor: pointer;
            z-index: 10;
            filter: brightness(0) saturate(100%) invert(88%) sepia(1%) saturate(0%) hue-rotate(0deg);
            transition: filter 0.3s ease-in-out;
        }
        .open-btn { left: 20px; }

        .home-btn, .share-btn {
            position: absolute;
            top: 15px;
            width: 40px;
            cursor: pointer;
            z-index: 10;
            filter: brightness(0) saturate(100%) invert(88%) sepia(1%) saturate(0%) hue-rotate(0deg);
        }
        .home-btn { right: 20px; }
        .share-btn { right: 85px; }

        body, html {
            height: 100;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: flex-start; 
            width: 100%;
            max-width: 800px; 
            height: calc(100vh - 80px);
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            margin: auto; 
            padding-bottom: 63px;
        }

        .scrollbar {
            position: fixed;
            top: 0;
            right: 100px;
            height: 100vh;
            width: 8px;
            background-color: #ddd;
            display: none;
            z-index: 50;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }

        .chat-container:scroll {
            display: block;
        }

        .chat-message, .hynang-message {
            background-color: lightgray;
            color: black;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 20px;
            width: 50%;
            text-align: left;
            word-wrap: break-word;
            position: relative;
        }
        .chat-message {
            align-self: flex-end;
        }
        .hynang-message {
            background-color: white;
            align-self: flex-start;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: opacity 1s ease-in;
        }
        .hynang-message img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .time-stamp {
            position: absolute;
            top: 3px;
            right: 10px;
            font-size: 10px;
            color: black;
            opacity: 0.7;
        }

        .chat-input-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            width: 80%;
            transform: translateX(-50%);
            max-width: 600px;
            background-color: white;
            border-radius: 30px;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
        }
        .chat-input-container textarea {
            border: none;
            flex-grow: 1;
            font-size: 14px;
            padding: 10px;
            outline: none;
            border-radius: 30px;
            resize: none;
            height: 45px;
            overflow-y: hidden;
        }
        .chat-input-container button {
            background: none;
            border: none;
            cursor: pointer;
        }
        .chat-input-container button img {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .plus-icon {
            position: absolute;
            left: 28px;
            bottom: 10px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        #share-menu {
            position: absolute;
            display: none;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 20;
        }
        #share-menu div {
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            color: black;
            text-align: center;
            white-space: nowrap;
        }
        #share-menu div:hover {
            background-color: #f0f0f0;
        }
        #file-list-container {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            overflow: hidden;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            background: #f0f0f0;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .file-name {
            color: black; 
        }
        .file-item span {
            flex-grow: 1;
            font-size: 14px;
        }

        .remove-btn {
            background: red;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 50%;
            cursor: pointer;
            width: 20px;
            height: 20px;
            font-size: 12px;
            text-align: center;
            margin-left: 8px;
        }
        .remove-btn:hover {
            background: darkred;
        }
        .new-chat-btn {
            position: absolute;
            top: 13px;
            right: 148px; 
            width: 45px; 
            cursor: pointer; 
            filter: brightness(0) invert(1); 
            transition: filter 0.3s ease-in-out; 
        }
        .new-chat-btn:hover {
            filter: brightness(0.8) invert(1); 
        }
        .send-btn {
    width: 45px; /* ë²„íŠ¼ í¬ê¸° */
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    cursor: pointer;
}
.search-container {
    position: fixed;
    bottom: 7px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 700px;
    background: none;
    border-radius: 30px;
    display: flex;
    align-items: center;
    padding: 0px;
    box-shadow: none;
    transition: all 0.3s ease-in-out;
    
    
}


.input-wrapper {
    flex-grow: 1;
    display: flex;
    align-items: center;
    background: white;  /* ì…ë ¥ì°½ë§Œ í°ìƒ‰ ë°°ê²½ ìœ ì§€ */
    border-radius: 30px;
    padding: 10px 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.search-container input[type="text"] {
    border: none;
    flex-grow: 1;
    font-size: 16px;
    padding: 10px 12px;
    outline: none;
    border-radius: 30px;
    height: 50px;
    background: none;  /* ë¶ˆí•„ìš”í•œ ë°°ê²½ ì œê±° */
    box-shadow: none;  /* ë¶ˆí•„ìš”í•œ ê·¸ë¦¼ì ì œê±° */
    position: relative;
    top: -16px;
}

.send-btn {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    cursor: pointer;
}

.send-btn img {
    width: 28px;
    height: 28px;
}

.send-btn img {
    width: 24px;  /* ì•„ì´ì½˜ í¬ê¸° */
    height: 24px;
    max-width: 100%;
    max-height: 100%;
}
textarea#queryInput {
    border: none;
    flex-grow: 1;
    font-size: 16px;
    font-family: 'Arial', sans-serif;
    padding: 10px 12px;
    outline: none;
    border-radius: 30px;
    resize: none; /*  ì‚¬ìš©ìê°€ í¬ê¸° ì¡°ì • ëª»í•˜ê²Œ ë§‰ìŒ */
    height: 50px;  /*  ê¸°ë³¸ ë†’ì´ */
    min-height: 50px; /*  ìµœì†Œ ë†’ì´ */
    max-height: 250px; /*  ìµœëŒ€ ë†’ì´ (ë” ì´ìƒ ì»¤ì§€ì§€ ì•Šë„ë¡ ì œí•œ) */
    line-height: 1.5;
    background: none;
    box-shadow: none;
    position: relative;
    top: -5px;
    overflow-y: auto; /*  ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìë™ìœ¼ë¡œ ìŠ¤í¬ë¡¤ */
    white-space: pre-wrap; /*  ìë™ ì¤„ë°”ê¿ˆ */
    word-wrap: break-word; /*  ë‹¨ì–´ê°€ ê¸¸ì–´ë„ ê°œí–‰ */
}
.search-results {
    display: none !important;
    
}

/* ì—°ë„ ì„ íƒ ëª©ë¡ ìŠ¤íƒ€ì¼ */
.year-selector {
    position: absolute;
    top: 10px;
    left: 35%;
    transform: translateX(-50%);
    background: white;
    padding: 5px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    font-size: 14px;
    z-index: 100; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ë¡œ */
}

.year-label {
    margin-right: 6px;
    color: black;
    font-weight: bold;
}

#yearSelect {
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 4px 8px;
    font-size: 14px;
    cursor: pointer;
}

    </style>
</head>
<body>
    <!-- ì›í•˜ëŠ” ì—°ë„ ì„ íƒ ë°•ìŠ¤ ì¶”ê°€ -->
    <div class="year-selector">
        <label for="yearSelect" class="year-label">ì›í•˜ëŠ” ì—°ë„ ì„ íƒ:</label>
        <select id="yearSelect">
            <option value="(ì„ íƒ)" selected>(ì„ íƒ)</option>
            <option value="2022-2024">2022ë…„ ~ 2024ë…„</option>
            <option value="2025">2025ë…„</option>
        </select>
    </div>

    <img src="List.png" alt="Sidebar Icon" class="open-btn" onclick="toggleSidebar()">
    <div class="share-container">
        <img src="New.png" alt="New Chat" class="new-chat-btn" onclick="resetChat()">
        <img src="Share.png" alt="Share Icon" class="share-btn" onclick="toggleShareMenu()">
        <div id="share-menu">
            <div onclick="shareToKakao()" style="display: flex; align-items: center; line-height: 1.5;">
                <img src="Kakaotalk.png" alt="KakaoTalk Icon" style="width: 20px; height: 20px; margin-right: 10px;">
                <span style="line-height: 1.8;">ì¹´ì¹´ì˜¤í†¡ ê³µìœ </span>
            </div>
            <div onclick="shareToInstagram()" style="display: flex; align-items: center; line-height: 1.5;">
                <img src="Instagram.png" alt="Instagram Icon" style="width: 20px; height: 20px; margin-right: 10px;">
                <span style="line-height: 1.8;">ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µìœ </span>
            </div>
        </div>
    </div>
    <img src="Home.png" alt="Home Icon" class="home-btn" onclick="location.href='index.html'">

    <div id="sidebar" class="sidebar">
        <div class="sidebar-content">
            <a href="#">ì˜¤ëŠ˜ì˜ ëŒ€í™”</a>
            <a href="#">ì–´ì œì˜ ëŒ€í™”</a>
            <a href="#">ì´ì „ ëŒ€í™” ë³´ê¸°</a>
        </div>
        <img src="Setting.png" alt="Settings" class="setting-icon" onclick="location.href='ê´€ë¦¬ìí™”ë©´.html'">
    </div>
    
    <div class="chat-container" id="chat-container"></div>

    <div class="search-container">
        <div class="search-results">
            <h3>ğŸ” ê²€ìƒ‰ ê²°ê³¼</h3>
            <p id="searchResultText"></p>
        
            <h3>ğŸ–¼ï¸ ê²€ìƒ‰ëœ ì´ë¯¸ì§€</h3>
            <img id="searchResultImage" style="max-width: 400px; display: none;">
        
            <h3>ğŸ¤– LLM ì‘ë‹µ</h3>
            <p id="llmResponse"></p>
        </div>
        <div id="share-menu" style="display: none; position: absolute; bottom: 60px; right: 20px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);">
            <button onclick="shareToKakao()">ì¹´ì¹´ì˜¤í†¡ ê³µìœ </button>
            <button onclick="shareToInstagram()">ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µìœ </button>
        </div>
        <img src="Plus.png" alt="Plus Icon" class="plus-icon" onclick="document.getElementById('file-input').click();">
        <input type="file" id="file-input" multiple onchange="displayFileList(event)" style="display: none;">
        <div id="file-list-container"></div>
        <div class="search-container" >
            <div class="input-wrapper">
        <textarea id="queryInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!" rows="1"></textarea>
        <button type="button" class="send-btn">
            <img src="Go.png" alt="Search Icon">
        </button>
    </div>
    </div>


<script>
// í˜„ì¬ ì‹œê°„ì„ "00:00" í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜.
function getCurrentTime() {
    const now = new Date();
    let hours = now.getHours();
    let minutes = now.getMinutes();
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}
// í•˜ëƒ¥ì´ ëŒ€ê¸° ë©”ì‹œì§€ (íƒ€ì´í•‘ íš¨ê³¼ ì ìš©).
function addHynangTypingMessage() {
    const chatContainer = document.getElementById("chat-container");

    // ìƒˆë¡œìš´ í•˜ëƒ¥ì´ ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±.
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("hynang-message");

    // í•˜ëƒ¥ì´ ì•„ì´ì½˜ ì¶”ê°€.
    const iconImg = document.createElement("img");
    iconImg.src = "hnyang2.ico";  
    iconImg.alt = "í•˜ëƒ¥ì´";

    // í…ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ.
    const contentDiv = document.createElement("div");
    contentDiv.style.display = "flex";
    contentDiv.style.flexDirection = "column";

    // íƒ€ì´í•‘ íš¨ê³¼ë¥¼ ì¤„ í…ìŠ¤íŠ¸ ìš”ì†Œ.
    const typingText = document.createElement("span");
    typingText.innerHTML = "";  

    // í˜„ì¬ ì‹œê°„ ì¶”ê°€.
    const timeSpan = document.createElement("span");
    timeSpan.classList.add("time-stamp");
    timeSpan.innerText = getCurrentTime(); // âœ… í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°


    contentDiv.appendChild(typingText);
    messageDiv.appendChild(iconImg);
    messageDiv.appendChild(contentDiv);
    chatContainer.appendChild(messageDiv);
    contentDiv.appendChild(timeSpan); // âœ… ì‹œê°„ ì¶”ê°€

    // ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤.
    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: "smooth" });

    // í•œ ê¸€ìì”© ë‚˜íƒ€ë‚˜ë„ë¡ ì„¤ì •. (ì¤„ë°”ê¿ˆ ë¬¸ì œ í•´ê²°)
    const fullText = "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥!\nì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë¼ëƒ¥!";
    let i = 0;
    let tempText = "";

    function typeEffect() {
        if (i < fullText.length) {
            if (fullText[i] === "\n") {
                tempText += "<br>";  // ì¤„ë°”ê¿ˆ ë¬¸ìì¼ ë•Œë§Œ `<br>` ì¶”ê°€.
            } else {
                tempText += fullText[i];
            }
            typingText.innerHTML = tempText; // innerHTMLì„ ì§ì ‘ ì—…ë°ì´íŠ¸.
            i++;
            setTimeout(typeEffect, 50);
        }
    }
    typeEffect();

    return messageDiv;
}

window.sendQuery = async function() {
    console.log("âœ… [DEBUG] sendQuery ì‹¤í–‰ë¨");

    const queryInput = document.getElementById("queryInput");
    const yearSelect = document.getElementById("yearSelect");

    if (!queryInput) {
        console.error("âŒ [ERROR] queryInput ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤!");
        return;
    }

    const query = queryInput.value.trim();
    const selectedYear = yearSelect.value;
    console.log("ğŸ”¹ ì…ë ¥ëœ ê²€ìƒ‰ì–´:", query);
    console.log("ğŸ”¹ ì„ íƒëœ ì—°ë„:", selectedYear);


    if (!query) {
        if (!window.alertTriggered) {  
            window.alertTriggered = true;
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ë‹¬ë¼ëƒ¥!");
            setTimeout(() => { window.alertTriggered = false; }, 500);
        }
        return;
    }

    // âœ… ì›í•˜ëŠ” ì—°ë„ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš°, ê²½ê³ ì°½ ë„ìš°ê³  ì „ì†¡ ì¤‘ë‹¨
    if (yearSelect.value === "(ì„ íƒ)") {
        alert("ì›í•˜ëŠ” ì—°ë„ë¥¼ ì„ íƒí•´ë‹¬ë¼ëƒ¥!");
        return;
    }

    // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€.
    addUserMessage(query);

    // 1ì´ˆ í›„ "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥!"ì„ ë¨¼ì € ì¶œë ¥.
    setTimeout(() => {
        addHynangTypingMessage();

        // "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥!"ì´ ì¶œë ¥ëœ í›„ì— ì„œë²„ ìš”ì²­ì„ ë³´ëƒ„.
        fetch("http://211.39.140.39:27500/rest/llm_answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_query: query, 
                selected_year: selectedYear
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("âœ… [DEBUG] ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);

            let imageUrl = data.image_url || null; 
            let hynangResponse = data.llm_text_answer || "ì´í•´í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì´ë‹¤ëƒ¥.\në‹¤ì‹œ ì§ˆë¬¸í•´ ë‹¬ë¼ëƒ¥!";

            // ì´í•´í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì´ë©´ "ê¸°ë‹¤ë¦¬ë¼ëƒ¥" ì—†ì´ ìµœì¢… ì‘ë‹µë§Œ ì¶œë ¥ & ì´ë¯¸ì§€ ë©”ì‹œì§€ X.
            if (hynangResponse.trim() === "ì´í•´í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì´ë‹¤ëƒ¥.\në‹¤ì‹œ ì§ˆë¬¸í•´ ë‹¬ë¼ëƒ¥!") {
                addHynangMessage(null, hynangResponse, false, 40, true); // âœ… ì´ë¯¸ì§€ X
            } else {
                // ì •ìƒì ì¸ ì§ˆë¬¸ì´ë©´ "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥!" ì¶œë ¥ í›„ 2.5ì´ˆ í›„ ìµœì¢… ì‘ë‹µ ì¶œë ¥.
                setTimeout(() => {
                    addHynangMessage(imageUrl, hynangResponse, false, 40, false);
                }, 2500);
            }
        })
        .catch(error => {
            console.error("âŒ ê²€ìƒ‰ ìš”ì²­ ì‹¤íŒ¨:", error);
            alert("âŒ ê²€ìƒ‰ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });

    }, 1000); //1ì´ˆ í›„ "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥!" ì¶œë ¥.(ì´í›„ ì„œë²„ ìš”ì²­)
    
    queryInput.value = "";
};




// ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜.
function addUserMessage(messageText) {
    const chatContainer = document.getElementById("chat-container");

    // ìƒˆë¡œìš´ ì‚¬ìš©ì ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±.
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("chat-message");

    // í…ìŠ¤íŠ¸ ì¶”ê°€.
    const textSpan = document.createElement("span");
    textSpan.innerText = messageText;

    // í˜„ì¬ ì‹œê°„ ì¶”ê°€.
    const timeSpan = document.createElement("span");
    timeSpan.classList.add("time-stamp");
    timeSpan.innerText = getCurrentTime(); // ğŸ”¹ í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°

    //  ë©”ì‹œì§€ ìš”ì†Œì— í…ìŠ¤íŠ¸ ì¶”ê°€.
    messageDiv.appendChild(textSpan);
    messageDiv.appendChild(timeSpan); // ğŸ”¹ ì‹œê°„ ì¶”ê°€

    // ì±„íŒ… ì»¨í…Œì´ë„ˆì— ì¶”ê°€.
    chatContainer.appendChild(messageDiv);

    // ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤.
    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: "smooth" });
}

// íƒ€ì´í•‘ íš¨ê³¼ í•¨ìˆ˜. (í•œ ê¸€ìì”© ì¶œë ¥)
function typeWriterEffect(targetElement, text, speed = 50) {
    let index = 0;
    targetElement.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    function type() {
        if (index < text.length) {
            let char = text[index];

            // ë„ì–´ì“°ê¸°ì¼ ê²½ìš° &nbsp;ë¡œ ë³€í™˜í•˜ì—¬ HTMLì—ì„œ ìœ ì§€.
            if (char === " ") {
                char = "&nbsp;";
            }

            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬ (HTMLì—ì„œ ì¸ì‹ ê°€ëŠ¥í•˜ë„ë¡ ë³€í™˜).
            if (char === "\n") {
                char = "<br>";
            }

            targetElement.innerHTML += char;
            index++;
            setTimeout(type, speed);
        }
    }
    type();
}
function addHynangMessage(imageUrl, messageText, isWaiting = false, typingSpeed = 30, hideImageMessage = false) {
    const chatContainer = document.getElementById("chat-container");

    // ìƒˆë¡œìš´ ì±—ë´‡ ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±.
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("hynang-message");

    // í•˜ëƒ¥ì´ ì•„ì´ì½˜ ì¶”ê°€.
    const iconImg = document.createElement("img");
    iconImg.src = "hnyang2.ico";
    iconImg.alt = "í•˜ëƒ¥ì´";

    // í…ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±.
    const contentDiv = document.createElement("div");
    contentDiv.style.display = "flex";
    contentDiv.style.flexDirection = "column";

    const textSpan = document.createElement("span");
    textSpan.style.whiteSpace = "pre-line"; 

    // í˜„ì¬ ì‹œê°„ ì¶”ê°€.
    const timeSpan = document.createElement("span");
    timeSpan.classList.add("time-stamp");
    timeSpan.innerText = getCurrentTime(); // ğŸ”¹ í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°

    // ë©”ì‹œì§€ ìš”ì†Œì— í…ìŠ¤íŠ¸ ë° ì‹œê°„ ì¶”ê°€.
    contentDiv.appendChild(textSpan);
    contentDiv.appendChild(timeSpan); // ğŸ”¹ ì‹œê°„ ì¶”ê°€

    // ë§í’ì„ ì— ì•„ì´ì½˜ + ë‚´ìš© ì¶”ê°€.
    messageDiv.appendChild(iconImg);
    messageDiv.appendChild(contentDiv);
    chatContainer.appendChild(messageDiv);

    if (isWaiting) {
        // íƒ€ì´í•‘ íš¨ê³¼ë¡œ "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥! ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë¼ëƒ¥!" ì¶œë ¥.
        const waitingText = "ì‘ë‹µì„ ì¶œë ¥í•˜ê³  ìˆë‹¤ëƒ¥!\nì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë¼ëƒ¥!";
        textSpan.innerText = ""; // ì´ˆê¸°í™”

        let index = 0;
        const typingEffect = setInterval(() => {
            if (index < waitingText.length) {
                textSpan.innerText += waitingText[index];
                index++;
            } else {
                clearInterval(typingEffect);
            }
        }, 80); // ê¸€ìë‹¹ 80ms ê°„ê²©ìœ¼ë¡œ ì¶œë ¥.(í•œ ê¸€ì í•œê¸€ìì”© ë³´ì´ê²Œ í•˜ëŠ”~)
    } else {
        // ìµœì¢… ì‘ë‹µ ì¶œë ¥.
        typeWriterEffect(textSpan, messageText, typingSpeed);
    }

    contentDiv.appendChild(textSpan);

 // ìµœì¢… ì‘ë‹µ ë°•ìŠ¤ì—ë§Œ ì´ë¯¸ì§€ ì¶”ê°€.
  // ì´ë¯¸ì§€ ê´€ë ¨ ë©”ì‹œì§€ ì²˜ë¦¬. (í•˜ëƒ¥ì´ ì²« ë©”ì‹œì§€ì—ëŠ” ìˆ¨ê¹€)
  // ì´í•´í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì¼ ê²½ìš°, "ê²€ìƒ‰ëœ ì´ë¯¸ì§€: X"ë¥¼ ì¶œë ¥í•˜ì§€ ì•Šê¸°.
    if (!hideImageMessage && messageText.trim() !== "ì´í•´í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì´ë‹¤ëƒ¥.\në‹¤ì‹œ ì§ˆë¬¸í•´ ë‹¬ë¼ëƒ¥!") {
        if (imageUrl) {
            const imageText = document.createElement("span");
            imageText.innerText = "\nê²€ìƒ‰ëœ ì´ë¯¸ì§€:";
            imageText.style.fontWeight = "bold";
            contentDiv.appendChild(imageText);

            const imageElement = document.createElement("img");
            imageElement.src = imageUrl;
            imageElement.alt = "ê²€ìƒ‰ëœ ì´ë¯¸ì§€";
            imageElement.style.maxWidth = "150px"; 
            imageElement.style.borderRadius = "8px"; 
            imageElement.style.marginTop = "5px";
            contentDiv.appendChild(imageElement);
        } else {
            const imageText = document.createElement("span");
            imageText.innerHTML = `<b style="color: red;">ê²€ìƒ‰ëœ ì´ë¯¸ì§€: X</b>`;
            contentDiv.appendChild(imageText);
        }
    }

    // ë§í’ì„ ì— ì•„ì´ì½˜ + ë‚´ìš© ì¶”ê°€.
    messageDiv.appendChild(iconImg);
    messageDiv.appendChild(contentDiv);

    // ì±„íŒ… ì»¨í…Œì´ë„ˆì— ì¶”ê°€.
    chatContainer.appendChild(messageDiv);

    // ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡ opacity ìˆ˜ì •.
    setTimeout(() => {
        messageDiv.style.opacity = "1";
    }, 50);

    // ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤.
    setTimeout(scrollToLastHynangMessage, 100);
}


window.toggleSidebar = function() {
            var sidebar = document.getElementById("sidebar");
            console.log("âœ… toggleSidebar ì‹¤í–‰ë¨");  // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€
            var openBtn = document.querySelector(".open-btn");
            console.log("í˜„ì¬ ì‚¬ì´ë“œë°” í´ë˜ìŠ¤:", sidebar.classList);

            sidebar.classList.toggle("open");

            if (sidebar.classList.contains("open")) {
                openBtn.style.filter = "none";
            } else {
                openBtn.style.filter = "brightness(0) saturate(100%) invert(88%) sepia(1%) saturate(0%) hue-rotate(0deg)";
            }
        };

        function resetChat() {
    console.log("âœ… [DEBUG] resetChat ì‹¤í–‰ë¨");
    
    // ì±„íŒ… ì»¨í…Œì´ë„ˆ ë‚´ìš© ì´ˆê¸°í™”.
    document.getElementById("chat-container").innerHTML = "";

    // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”.
    document.getElementById("searchResultText").innerText = "";
    document.getElementById("llmResponse").innerText = "";

    alert("ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!");

    // í•˜ëƒ¥ì´ ì²« ë©”ì‹œì§€ ìë™ ì¶œë ¥. (ëŒ€í™”ì°½ ì´ˆê¸°í™” í›„)
    setTimeout(() => {
        addHynangMessage(null, "ê¶ê¸ˆí•œê²Œ ìˆëƒ¥?\në‚˜í•œí…Œ ë‹¤ ë¬¼ì–´ë´ë‘!", false, 50, true);
    }, 1000);
}
window.toggleShareMenu = function() {
    var menu = document.getElementById("share-menu");
    var shareBtn = document.querySelector(".share-btn");

    if (menu.style.display === "none" || menu.style.display === "") {
        var rect = shareBtn.getBoundingClientRect();
        menu.style.top = rect.bottom + window.scrollY + 10 + "px";  
        menu.style.left = (rect.left - 65) + "px"; 
        menu.style.display = "block";
    } else {
        menu.style.display = "none";
    }
};

// Shift + Enter â†’ ì…ë ¥ì°½ê³¼ ì…ë ¥ì°½ì„ ê°ì‹¸ëŠ” ë°•ìŠ¤ë¥¼ í™•ì¥.
// Ctrl + Z â†’ ì…ë ¥ì°½ê³¼ ë°•ìŠ¤ë¥¼ ì¶•ì†Œ.
function handleTextareaResize(event) {
    const inputField = document.getElementById("queryInput");
    const wrapper = document.querySelector(".input-wrapper"); // ì…ë ¥ì°½ì„ ê°ì‹¸ëŠ” ë°•ìŠ¤.

    if (!inputField || !wrapper) return;

    let expansionAmount = 15; // í™•ì¥ë˜ëŠ” ê¸¸ì´ ì¡°ì ˆ.
    let maxHeight = 200; //  ìµœëŒ€ ë†’ì´ ì œí•œ.
    let minHeight = 50; // ìµœì†Œ ë†’ì´.

    if (event.key === "Enter" && event.shiftKey) { 
        event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ì „ì†¡ ë§‰ê¸°)

        // scrollHeightì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì¼ì • í¬ê¸°ì”© ì¦ê°€.
        let currentHeight = parseInt(window.getComputedStyle(inputField).height);
        let newHeight = Math.min(currentHeight + expansionAmount, maxHeight);
        inputField.style.height = `${newHeight}px`;

        let wrapperHeight = parseInt(window.getComputedStyle(wrapper).height);
        let newWrapperHeight = Math.min(wrapperHeight + expansionAmount, maxHeight);
        wrapper.style.height = `${newWrapperHeight}px`;
    }

    if (event.key === "z" && event.ctrlKey) {  
        event.preventDefault(); // ê¸°ë³¸ Ctrl+Z ë™ì‘ ë°©ì§€.

       // ìµœì†Œ ë†’ì´ë¥¼ ë³´ì¥í•˜ë©´ì„œ ì¼ì • í¬ê¸°ì”© ê°ì†Œ.
        let currentHeight = parseInt(window.getComputedStyle(inputField).height);
        let newHeight = Math.max(currentHeight - expansionAmount, minHeight);
        inputField.style.height = `${newHeight}px`;

        let wrapperHeight = parseInt(window.getComputedStyle(wrapper).height);
        let newWrapperHeight = Math.max(wrapperHeight - expansionAmount, minHeight);
        wrapper.style.height = `${newWrapperHeight}px`;
    }
}
// .Enter í‚¤ ì…ë ¥ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜.(shift enter ê´€ë ¨)
function handleEnterKey(event) {
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault(); // ê¸°ë³¸ ì¤„ë°”ê¿ˆ ë§‰ê¸°
        console.log("ğŸ”¹ Enter í‚¤ ê°ì§€ë¨ (ì§ˆë¬¸ ì „ì†¡)");
        sendQuery(); // ì§ˆë¬¸ ì „ì†¡
    }
}


// DOMì´ ë¡œë“œëœ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡.
document.addEventListener("DOMContentLoaded", function() {
    console.log("âœ… [DEBUG] ë©”ì¸í™”ë©´ ë¡œë“œë¨");

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸°.
    loadChatHistory();

    const inputField = document.getElementById("queryInput");
    const wrapper = document.querySelector(".input-wrapper"); // ë¶€ëª¨ ë°•ìŠ¤
    const searchButton = document.querySelector(".send-btn"); // ì „ì†¡ ë²„íŠ¼ ì„ íƒ
    let prevHeights = [];  // ğŸ”¹ ë†’ì´ ë³€ê²½ ì´ë ¥ ì €ì¥ (Ctrl+Z ë³µêµ¬ìš©)
    const defaultWrapperHeight = wrapper ? wrapper.offsetHeight : 60; // ê¸°ë³¸ ë†’ì´ ì €ì¥

    console.log("âœ… [DEBUG] inputField:", inputField);
    console.log("âœ… [DEBUG] searchButton:", searchButton);
    console.log("âœ… [DEBUG] searchButton:", searchButton);

     // í•˜ëƒ¥ì´ ì²« ë©”ì‹œì§€ ìë™ ì¶œë ¥ (if ëŒ€í™” ë‚´ì—­ì´ ì—†ì„ ë•Œë§Œ)
    if (!sessionStorage.getItem("chatHistory")) {
        setTimeout(() => {
            addHynangMessage(null, "ê¶ê¸ˆí•œê²Œ ìˆëƒ¥?\në‚˜í•œí…Œ ë‹¤ ë¬¼ì–´ë´ë‘!", false, 50, true);
        }, 1000);
    };
    
    if (inputField) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€. (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
        inputField.removeEventListener("keydown", handleEnterKey);
        inputField.addEventListener("keydown", handleEnterKey);
        
        inputField.removeEventListener("keydown", handleTextareaResize);
        inputField.addEventListener("keydown", handleTextareaResize);
        const yearSelect = document.getElementById("yearSelect");

        if (yearSelect) {
        yearSelect.addEventListener("change", function () {
            const selectedYear = yearSelect.value;
            let yearText = "";

            if (selectedYear === "(ì„ íƒ)") {
                inputField.placeholder = "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!";
                return; // ê¸°ë³¸ ìƒíƒœ ìœ ì§€
            } else if (selectedYear === "2022-2024") {
                yearText = "í˜„ì¬ 2022ë…„ ~ 2024ë…„ ì„ íƒ";
            } else if (selectedYear === "2025") {
                yearText = "í˜„ì¬ 2025ë…„ ì„ íƒ";
            }

            inputField.placeholder = `ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”! (${yearText})`;
        });
    }   
    } else {
        console.error("âŒ queryInputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
    }

    if (searchButton) {
        // ğŸš¨ ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
        searchButton.removeEventListener("click", sendQuery);
        searchButton.addEventListener("click", sendQuery);
    } else {
        console.error("âŒ ê²€ìƒ‰ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
    }
});

// í˜„ì¬ ì±„íŒ… ë‚´ìš©ì„ ì €ì¥í•˜ëŠ” í•¨ìˆ˜.
function saveChatHistory() {
    const chatContainer = document.getElementById("chat-container");
    sessionStorage.setItem("chatHistory", chatContainer.innerHTML);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°.
function loadChatHistory() {
    const chatContainer = document.getElementById("chat-container");
    const savedChat = sessionStorage.getItem("chatHistory");
    if (savedChat) {
        chatContainer.innerHTML = savedChat;
    }
}

// í˜ì´ì§€ë¥¼ ë– ë‚˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨í•  ë•Œ ì±„íŒ… ë‚´ìš© ì €ì¥.
window.addEventListener("beforeunload", function() {
    saveChatHistory();
});

document.querySelector(".home-btn").addEventListener("click", function() {
    saveChatHistory(); // ëŒ€í™” ì €ì¥ í›„ ì´ë™.
    location.href = "index.html";
});

document.querySelector(".setting-icon").addEventListener("click", function() {
    saveChatHistory(); // ëŒ€í™” ì €ì¥ í›„ ì´ë™.
    location.href = "ê´€ë¦¬ìí™”ë©´.html";
});

function scrollToLastHynangMessage() {
    const chatContainer = document.getElementById("chat-container");
    const hynangMessages = document.querySelectorAll(".hynang-message"); // ëª¨ë“  í•˜ëƒ¥ì´ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°.

    if (hynangMessages.length > 0) {
        const lastHynangMessage = hynangMessages[hynangMessages.length - 1]; // ë§ˆì§€ë§‰ í•˜ëƒ¥ì´ ë©”ì‹œì§€ ì„ íƒ.

        lastHynangMessage.scrollIntoView({ behavior: "smooth", block: "end" });
    }
}



</script>

</body>
</html>

